# apps/web Refactoring Plan

## Обзор

Этот документ содержит план рефакторинга для Next.js приложения `apps/web`. Задачи организованы по приоритету:
- **P0** — Критические проблемы (блокирующие)
- **P1** — Важные улучшения качества
- **P2** — Минорные улучшения
- **P3** — Будущие рассмотрения

---

## P0: Critical Issues

### 1. Исправить захардкоженные метаданные в layout.tsx
- [ ] **Проблема**: Root layout содержит дефолтные метаданные от create-next-app
  ```typescript
  // ❌ Текущее состояние
  export const metadata: Metadata = {
    title: "Create Next App",
    description: "Generated by create next app",
  };
  ```
- [ ] **Решение**: Заменить на корректные метаданные для Senlo
  ```typescript
  // ✅ Правильный подход
  export const metadata: Metadata = {
    title: "Senlo - Email Builder",
    description: "Open-source self-hosted email builder platform",
  };
  ```
- **Файл**: `app/layout.tsx:16-19`

### 2. Улучшить обработку ошибок в Server Actions
- [ ] **Проблема**: Простые throw new Error() без структурированной обработки
  ```typescript
  // ❌ Текущее состояние
  if (!name || !projectId || !templateId) {
    throw new Error("Missing required fields");
  }
  ```
- [ ] **Решение**: Создать систему структурированных ошибок
  ```typescript
  // ✅ Правильный подход
  import { ActionError } from '../lib/errors';
  
  if (!name || !projectId || !templateId) {
    throw new ActionError('VALIDATION_ERROR', 'Missing required fields', {
      missingFields: ['name', 'projectId', 'templateId'].filter(f => !eval(f))
    });
  }
  ```
- **Файлы**: 
  - `app/campaigns/actions.ts:115-117`
  - `app/projects/actions.ts:21-24`
  - Все Server Actions

### 3. Добавить error.tsx и loading.tsx файлы
- [ ] **Проблема**: Отсутствуют error boundaries и loading states для route segments
- [ ] **Решение**: Добавить error.tsx и loading.tsx в ключевые директории:
  ```
  app/
  ├── error.tsx              # Global error boundary
  ├── loading.tsx            # Global loading UI
  ├── projects/
  │   ├── error.tsx          # Projects-specific errors
  │   ├── loading.tsx        # Projects loading
  │   └── [id]/
  │       ├── error.tsx      # Project detail errors
  │       └── loading.tsx    # Project detail loading
  ├── campaigns/
  │   ├── error.tsx
  │   ├── loading.tsx
  │   └── [id]/
  │       ├── error.tsx
  │       └── loading.tsx
  └── editor/[id]/
      ├── error.tsx
      └── loading.tsx
  ```
- **Критичность**: Без error boundaries ошибки могут крашить всё приложение

### 4. Устранить console.error в production коде
- [ ] **Проблема**: Использование console.error в production может выставлять sensitive информацию
  ```typescript
  // ❌ Проблемные места
  console.error("Failed to delete campaign:", error);           // campaign-card.tsx:39
  console.error("Failed to parse variablesSchema:", e);         // actions.ts:107,160
  console.error("Triggered email error:", error);              // route.ts:125
  console.error(`Failed to send to ${contact.email}:`, result.error); // actions.ts:264
  ```
- [ ] **Решение**: Заменить на структурированное логирование
  ```typescript
  // ✅ Правильный подход
  import { logger } from '../lib/logger';
  
  logger.error('Failed to delete campaign', { 
    campaignId: campaign.id, 
    error: error.message 
  });
  ```
- **Требует**: Создание системы логирования

---

## P1: Quality Improvements

### 5. Создать централизованную систему логирования
- [ ] **Проблема**: Разрозненные console.log/error по всему приложению
- [ ] **Решение**: Создать структурированную систему логирования
  ```typescript
  // lib/logger.ts
  interface LogContext {
    userId?: number;
    sessionId?: string;
    requestId?: string;
    [key: string]: any;
  }
  
  export const logger = {
    error: (message: string, context?: LogContext) => { /* */ },
    warn: (message: string, context?: LogContext) => { /* */ },
    info: (message: string, context?: LogContext) => { /* */ },
    debug: (message: string, context?: LogContext) => { /* */ },
  };
  ```
- **Интеграции**: Winston, Pino, или простая JSON структура для local development

### 6. Унифицировать обработку FormData в Server Actions
- [ ] **Проблема**: Повторяющаяся логика извлечения и валидации FormData
  ```typescript
  // Этот паттерн повторяется в каждой action
  const name = String(formData.get("name") || "").trim();
  const description = String(formData.get("description") || "").trim() || null;
  ```
- [ ] **Решение**: Создать хелперы для парсинга FormData
  ```typescript
  // lib/form-helpers.ts
  export function parseFormData<T>(formData: FormData, schema: FormSchema<T>): T {
    // Валидация и парсинг по схеме
  }
  
  // Использование
  const data = parseFormData(formData, {
    name: { type: 'string', required: true },
    description: { type: 'string', required: false },
    projectId: { type: 'number', required: true }
  });
  ```

### 7. Добавить типизацию для API routes
- [ ] **Проблема**: API routes не имеют строгой типизации request/response
- [ ] **Решение**: Создать типы для API контрактов
  ```typescript
  // types/api.ts
  export interface TriggeredEmailRequest {
    campaignId: number;
    to: string;
    data?: Record<string, any>;
  }
  
  export interface TriggeredEmailResponse {
    success: boolean;
    message?: string;
    error?: string;
  }
  ```
- **Файлы**: 
  - `app/api/triggered/route.ts`
  - `app/api/track/*/route.ts`

### 8. Оптимизировать компоненты списков с мемоизацией
- [ ] **Проблема**: Компоненты карточек не оптимизированы для больших списков
- [ ] **Решение**: Добавить React.memo и оптимизировать ре-рендеры
  ```typescript
  // ✅ Оптимизированные компоненты
  export const ProjectCard = React.memo(({ project }: ProjectCardProps) => {
    // ...
  });
  ProjectCard.displayName = "ProjectCard";
  
  export const CampaignCard = React.memo(({ campaign }: CampaignCardProps) => {
    // ...
  });
  CampaignCard.displayName = "CampaignCard";
  ```
- **Файлы**:
  - `app/projects/project-card.tsx`
  - `app/campaigns/campaign-card.tsx`
  - `app/projects/[id]/template-card.tsx`

### 9. Создать переиспользуемые хуки для data fetching
- [ ] **Проблема**: Повторяющаяся логика загрузки данных в компонентах
- [ ] **Решение**: Извлечь в кастомные хуки
  ```typescript
  // hooks/use-projects.ts
  export function useProjects() {
    const [projects, setProjects] = useState<Project[]>([]);
    const [loading, setLoading] = useState(true);
    // ...
  }
  
  // hooks/use-campaign-details.ts
  export function useCampaignDetails(id: number) {
    // ...
  }
  ```
- **Преимущества**: Переиспользование, лучшее тестирование, консистентность

### 10. Добавить валидацию окружения
- [ ] **Проблема**: Отсутствует проверка обязательных environment variables
- [ ] **Решение**: Создать валидацию при старте приложения
  ```typescript
  // lib/env.ts
  import { z } from 'zod';
  
  const envSchema = z.object({
    NEXT_PUBLIC_APP_URL: z.string().url(),
    DATABASE_URL: z.string(),
    // другие обязательные переменные
  });
  
  export const env = envSchema.parse(process.env);
  ```
- **Файлы**: Используется в `app/api/triggered/route.ts:69`

---

## P2: Minor Improvements

### 11. Улучшить accessibility для Sidebar
- [ ] **Проблема**: Отсутствуют ARIA атрибуты для навигации
- [ ] **Решение**: Добавить правильные роли и атрибуты
  ```typescript
  <aside 
    className="..." 
    role="navigation" 
    aria-label="Main navigation"
  >
    <nav aria-label="Project navigation">
      {/* Навигационные элементы */}
    </nav>
  </aside>
  ```
- **Файл**: `components/sidebar/sidebar.tsx`

### 12. Добавить JSDoc документацию
- [ ] **Проблема**: Отсутствует документация для Server Actions
- [ ] **Решение**: Добавить JSDoc к публичным функциям
  ```typescript
  /**
   * Creates a new project with the provided form data.
   * 
   * @param formData - Form data containing name and optional description
   * @throws {Error} When project name is missing or empty
   * @returns Promise that resolves when project is created
   */
  export async function createProject(formData: FormData): Promise<void> {
    // ...
  }
  ```
- **Файлы**: Все `actions.ts` файлы

### 13. Унифицировать стили для состояний загрузки
- [ ] **Проблема**: Разные подходы к отображению loading states
- [ ] **Решение**: Создать консистентные loading компоненты в @senlo/ui
  ```typescript
  // Использование
  <LoadingCard />
  <LoadingButton loading={isSubmitting}>Save</LoadingButton>
  <LoadingSpinner size="sm" />
  ```

### 14. Оптимизировать Bundle Size
- [ ] **Проблема**: Нет анализа размера bundle
- [ ] **Действия**:
  1. Добавить `@next/bundle-analyzer`
  2. Проанализировать импорты Lucide React (используется много иконок)
  3. Проверить tree-shaking для @senlo/* пакетов
- [ ] **Команда**: `ANALYZE=true npm run build`

### 15. Консистентность naming conventions
- [ ] **Проблема**: Смешанные соглашения по именованию
  ```typescript
  // Найдены разные стили
  getCampaignDetails()        // camelCase
  listAllCampaigns()         // verb + noun
  getWizardData()            // get + noun
  ```
- [ ] **Решение**: Унифицировать к одному стилю (предпочтительно: verb + noun)

---

## P3: Future Considerations

### 16. Добавить End-to-End тесты
- [ ] **Инструменты**: Playwright или Cypress
- [ ] **Покрытие**: Критические пользовательские сценарии
  - Создание проекта → шаблона → кампании
  - Редактирование в Editor
  - Отправка тестового email

### 17. Реализовать Offline Support
- [ ] **Контекст**: PWA возможности для работы с черновиками
- [ ] **Технологии**: Service Workers, IndexedDB
- [ ] **Приоритет**: Низкий (не critical для email builder)

### 18. Добавить Real-time уведомления
- [ ] **Контекст**: WebSocket соединения для статусов кампаний
- [ ] **Технологии**: Socket.io, Server-Sent Events
- [ ] **Триггер**: Когда появятся multi-user сценарии

### 19. Кеширование на уровне приложения
- [ ] **Инструменты**: React Query / TanStack Query
- [ ] **Области**: Проекты, шаблоны, кампании
- [ ] **Преимущества**: Offline cache, optimistic updates

### 20. Internationalization (i18n)
- [ ] **Библиотека**: next-intl
- [ ] **Области**: UI strings, error messages, email templates
- [ ] **Приоритет**: Низкий до появления international пользователей

---

## Прогресс

| Приоритет | Всего | Выполнено | Оставшиеся |
|-----------|-------|-----------|------------|
| P0        | 4     | 0         | 4          |
| P1        | 6     | 0         | 6          |
| P2        | 5     | 0         | 5          |
| P3        | 5     | 0         | 5          |
| **Итого** | **20**| **0**     | **20**     |

---

## Порядок выполнения

**Рекомендуемый порядок:**

1. **P0.1** — Исправить метаданные (быстрая победа)
2. **P0.3** — Добавить error.tsx/loading.tsx (критично для UX)
3. **P0.4** — Заменить console.error (требует P1.5)
4. **P1.5** — Создать систему логирования
5. **P0.2** — Структурированные ошибки в Server Actions
6. **P1.6** — Унифицировать FormData парсинг
7. **P1.7** — Типизация API routes
8. **P1.10** — Валидация окружения
9. **P1.8** — Мемоизация компонентов
10. **P1.9** — Переиспользуемые хуки
11. **P2.12** — JSDoc документация
12. **P2.14** — Bundle анализ

---

## Архитектурные принципы

### Error Handling Strategy
```typescript
// Стандартная структура ошибок
interface AppError {
  code: string;
  message: string;
  details?: Record<string, any>;
  cause?: Error;
}

// Server Action результат
type ActionResult<T> = 
  | { success: true; data: T }
  | { success: false; error: AppError };
```

### Loading States Pattern
```typescript
interface AsyncState<T> {
  data: T | null;
  loading: boolean;
  error: string | null;
}
```

### Form Validation Strategy
```typescript
// Zod схемы для валидации форм
// react-hook-form для клиентской валидации
// Server-side валидация в Server Actions
```

---

## История изменений

| Дата | Изменение |
|------|-----------|
| 2025-12-28 | Создание документа после анализа apps/web |
